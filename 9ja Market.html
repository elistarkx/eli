<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Elichat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 2vw;
            overflow-x: hidden;
            color: #fff;
        }
        .container {
            max-width: 100%;
            width: 95vw;
            margin: auto;
            background: rgba(255, 255, 255, 0.9);
            padding: clamp(10px, 2vw, 20px);
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
            flex-grow: 1;
            height: 90vh;
            display: flex;
            overflow: hidden;
        }
        .hidden { display: none; }
        .active { display: flex; }
        h1, h2 { color: #ff6f61; }
        .btn {
            padding: clamp(8px, 1.5vw, 15px) clamp(15px, 3vw, 30px);
            background: #ff6f61;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            width: 100%;
            max-width: 200px;
            margin: clamp(5px, 1vw, 10px) 0;
            font-size: clamp(12px, 2vw, 16px);
        }
        .btn:hover {
            background: #ff3d2e;
            transform: scale(1.05);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover { background: #5a6268; }
        .btn-icon {
            padding: clamp(8px, 1.5vw, 15px);
            width: auto;
            max-width: none;
            font-size: clamp(14px, 2.5vw, 18px);
            background: #34c759;
        }
        .btn-icon:hover { background: #28a745; }
        input, select, textarea {
            padding: clamp(8px, 1.5vw, 15px);
            margin: clamp(5px, 1vw, 10px) 0;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: clamp(12px, 2vw, 16px);
            background: #fff;
            color: #333;
        }
        .form-group { margin-bottom: clamp(10px, 2vw, 20px); width: 100%; }
        .phone-group {
            display: flex;
            gap: clamp(5px, 1vw, 10px);
            flex-wrap: wrap;
        }
        #login-country-code, #country-code { width: 30%; min-width: 80px; }
        #login-phone-number, #phone-number { width: 70%; flex-grow: 1; }

        /* Chat Layout */
        .chat-container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        .chat-sidebar, .chat-window {
            height: 100%;
            overflow-y: auto;
        }
        .chat-sidebar {
            width: 30%;
            background: rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: clamp(10px, 2vw, 20px);
        }
        .chat-window {
            width: 70%;
            padding: clamp(10px, 2vw, 20px);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            display: flex;
            align-items: center;
            margin-bottom: clamp(10px, 2vw, 20px);
            flex-wrap: wrap;
            gap: clamp(10px, 2vw, 20px);
        }
        .friend-pic {
            width: clamp(30px, 6vw, 40px);
            height: clamp(30px, 6vw, 40px);
            border-radius: 50%;
            margin-right: clamp(10px, 2vw, 20px);
            background-size: cover;
            border: 2px solid #ff6f61;
        }
        .chat-list li {
            padding: clamp(10px, 2vw, 20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: clamp(10px, 2vw, 20px);
            background: rgba(255, 255, 255, 0.05);
            transition: background 0.3s;
        }
        .chat-list li:hover { background: rgba(255, 255, 255, 0.15); }
        .chat-list li.unread::after {
            content: 'â€¢';
            color: #ff6f61;
            font-size: clamp(12px, 2vw, 16px);
            margin-left: clamp(5px, 1vw, 10px);
        }
        .friend-info { flex-grow: 1; color: #333; }
        .recent-message {
            font-size: clamp(10px, 1.5vw, 12px);
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .timestamp {
            font-size: clamp(10px, 1.5vw, 12px);
            color: #888;
            margin-left: clamp(5px, 1vw, 10px);
        }
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: clamp(10px, 2vw, 20px);
            background: linear-gradient(135deg, #f0f4f8, #e9ecef);
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: clamp(10px, 2vw, 20px);
        }
        .message {
            margin: clamp(5px, 1vw, 10px) 0;
            padding: clamp(8px, 1.5vw, 15px);
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: clamp(12px, 2vw, 16px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .sent {
            background: linear-gradient(135deg, #34c759, #28a745);
            margin-left: auto;
            text-align: right;
            color: white;
        }
        .received {
            background: linear-gradient(135deg, #ff9f1c, #ff6f61);
            margin-right: auto;
            color: white;
        }
        .message img, .message video, .message audio {
            max-width: 100%;
            margin-top: clamp(5px, 1vw, 10px);
            border-radius: 5px;
            object-fit: contain;
        }
        .message a {
            color: #fff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: clamp(5px, 0.5vw, 10px);
        }
        .message a:hover { text-decoration: underline; }
        .file-icon {
            width: clamp(16px, 2vw, 20px);
            height: clamp(16px, 2vw, 20px);
        }
        .chat-input {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: clamp(5px, 1vw, 10px);
            background: rgba(255, 255, 255, 0.1);
            padding: clamp(5px, 1vw, 10px);
            border-radius: 5px;
            margin-top: clamp(10px, 2vw, 20px);
        }
        #message-input { 
            flex-grow: 1; 
            margin-right: clamp(5px, 1vw, 10px); 
            background: rgba(255, 255, 255, 0.8); 
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #media-input { display: none; }
        .elichat-3d {
            font-size: clamp(1.5em, 5vw, 2.5em);
            font-weight: bold;
            color: #34c759;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5), 
                        -1px -1px 3px rgba(255, 255, 255, 0.8);
            letter-spacing: 2px;
        }

        /* Buttons and Layout on Home Page */
        .welcome-section {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: clamp(5px, 1vw, 10px);
            border-radius: 5px;
            margin-bottom: clamp(10px, 2vw, 20px);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: clamp(5px, 1vw, 10px);
            justify-content: center;
            margin-bottom: clamp(10px, 2vw, 20px);
        }
        .status-section {
            margin-top: clamp(5px, 1vw, 10px);
            padding: clamp(5px, 1vw, 10px);
            border: 1px solid #ddd;
            border-radius: 5px;
            background: linear-gradient(135deg, #f0f4f8, #e9ecef);
            max-height: 50vh;
            overflow-y: auto;
        }
        #my-status-list {
            margin-top: clamp(10px, 2vw, 20px);
            max-height: 70vh;
            overflow-y: auto;
        }
        .friend-status-group {
            margin-bottom: clamp(10px, 2vw, 20px);
        }
        .friend-name {
            font-weight: bold;
            font-size: clamp(14px, 2.5vw, 18px);
            color: #ff6f61;
            margin-bottom: clamp(5px, 1vw, 10px);
            display: flex;
            align-items: center;
            gap: clamp(5px, 1vw, 10px);
        }
        .status-item, .my-status-item {
            padding: clamp(5px, 1vw, 10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            word-wrap: break-word;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: clamp(5px, 1vw, 10px);
            color: #333;
            display: flex;
            align-items: center;
        }
        .status-item-content, .my-status-item-content {
            flex-grow: 1;
        }
        .status-item img, .status-item video, .status-item audio,
        .my-status-item img, .my-status-item video, .my-status-item audio {
            width: 100%;
            margin-top: clamp(5px, 1vw, 10px);
            border-radius: 5px;
            object-fit: contain;
        }
        .status-item a, .my-status-item a {
            color: #007bff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: clamp(5px, 0.5vw, 10px);
        }
        .status-item a:hover, .my-status-item a:hover { text-decoration: underline; }

        /* Profile and Other Sections */
        .profile-details {
            padding: clamp(10px, 2vw, 20px);
            border: 1px solid #ddd;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            margin-top: clamp(10px, 2vw, 20px);
            font-size: clamp(12px, 2vw, 16px);
            color: #333;
        }
        #camera-preview {
            width: 100%;
            max-width: 200px;
            height: auto;
            margin-top: clamp(10px, 2vw, 20px);
            border-radius: 5px;
        }
        #view-my-status {
            position: absolute;
            top: clamp(5px, 1vw, 10px);
            left: clamp(5px, 1vw, 10px);
            color: #007bff;
            cursor: pointer;
            font-size: clamp(12px, 2vw, 16px);
        }
        #view-my-status:hover { text-decoration: underline; }
        .wifi-options {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: clamp(5px, 1vw, 10px);
            display: none;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .wifi-options button {
            display: block;
            width: 100%;
            margin: clamp(2px, 0.5vw, 5px) 0;
            background: #ff9f1c;
        }
        .wifi-options button:hover { background: #ff6f61; }
        #connected-users {
            margin-top: clamp(5px, 1vw, 10px);
            padding: clamp(5px, 1vw, 10px);
            border: 1px solid #ddd;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #333;
        }
        #status-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: clamp(10px, 2vw, 20px);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: clamp(300px, 80vw, 600px);
            max-height: 90vh;
            overflow-y: auto;
        }
        #status-modal canvas, #status-modal video {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: clamp(5px, 1vw, 10px) 0;
        }
        #status-modal textarea {
            resize: vertical;
            min-height: 100px;
        }
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .container { width: 95vw; }
            .phone-group { flex-direction: column; }
            #login-country-code, #country-code, #login-phone-number, #phone-number { width: 100%; }
            .chat-container { flex-direction: column; }
            .chat-sidebar, .chat-window { width: 100%; height: auto; }
            .chat-sidebar { border-right: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
            .btn { width: 100%; max-width: none; }
            .welcome-section { padding: clamp(5px, 2vw, 10px); }
            .button-group { flex-direction: column; align-items: center; }
        }
        @media (max-width: 480px) {
            .container { width: 98vw; padding: clamp(8px, 2.5vw, 15px); }
            .user-pic, .friend-pic { width: clamp(25px, 8vw, 35px); height: clamp(25px, 8vw, 35px); }
            .status-pic { width: clamp(15px, 5vw, 25px); height: clamp(15px, 5vw, 25px); }
            .header { flex-direction: column; text-align: center; gap: clamp(5px, 2vw, 10px); }
            .btn { padding: clamp(6px, 2vw, 12px) clamp(10px, 3vw, 20px); }
            #status-modal { width: 90vw; }
        }
    </style>
</head>
<body>
    <div class="container active" id="loginPage">
        <h1 class="elichat-3d">Elichat</h1>
        <div class="form-group">
            <div class="phone-group">
                <select id="login-country-code" required>
                    <option value="+1">+1 (USA)</option>
                    <option value="+44">+44 (UK)</option>
                    <option value="+91">+91 (India)</option>
                    <option value="+234">+234 (Nigeria)</option>
                    <option value="+33">+33 (France)</option>
                    <option value="+61">+61 (Australia)</option>
                </select>
                <input type="text" id="login-phone-number" placeholder="Phone Number" required>
            </div>
            <input type="password" id="login-password" placeholder="Password" required>
            <button class="btn" onclick="login()">Login</button>
            <p>Not registered? <a href="#" onclick="showRegister()">Create an Account</a></p>
        </div>
    </div>

    <div class="container hidden" id="registerPage">
        <h1 class="elichat-3d">Elichat</h1>
        <div class="form-group">
            <input type="text" id="first-name" placeholder="First Name" required>
            <input type="text" id="surname" placeholder="Surname" required>
            <input type="password" id="register-password" placeholder="Password" required>
            <div class="phone-group">
                <select id="country-code" required>
                    <option value="+1">+1 (USA)</option>
                    <option value="+44">+44 (UK)</option>
                    <option value="+91">+91 (India)</option>
                    <option value="+234">+234 (Nigeria)</option>
                    <option value="+33">+33 (France)</option>
                    <option value="+61">+61 (Australia)</option>
                </select>
                <input type="text" id="phone-number" placeholder="Phone Number" required>
            </div>
            <button class="btn" onclick="register()">Register</button>
            <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
        </div>
    </div>

    <div class="container hidden" id="homePage">
        <h1 class="elichat-3d">Elichat</h1>
        <div class="welcome-section">
            <div class="header">
                <div class="user-pic" id="user-pic" onclick="showProfile()"></div>
                <h2>Welcome, <span id="user-name"></span>!</h2>
            </div>
            <div class="button-group">
                <button class="btn" onclick="showProfile()">Profile</button>
                <button class="btn" id="status-btn" onclick="openStatusModal()">Upload Status</button>
                <button class="btn" id="wifi-btn" onclick="toggleWifiOptions()">Connect Wi-Fi</button>
                <div class="wifi-options" id="wifi-options">
                    <button class="btn" onclick="connectWifi('hotspot')">Hotspot</button>
                    <button class="btn" onclick="connectWifi('wifi')">Wi-Fi</button>
                </div>
                <button class="btn" onclick="goLive()">Go Live</button>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <div class="status-section" id="status-section">
                <div id="view-my-status" onclick="showMyStatus()">View My Status</div>
                <div id="status-list"></div>
            </div>
        </div>
        <div id="connected-users"></div>
        <div class="form-group">
            <input type="text" id="add-friend" placeholder="Add Friend (e.g., +12025550123)">
            <button class="btn" onclick="addFriend()">Add</button>
        </div>
    </div>

    <div class="container hidden" id="chatPage">
        <h1 class="elichat-3d">Elichat</h1>
        <div class="chat-container">
            <div class="chat-sidebar">
                <ul class="chat-list" id="friends-list" aria-live="polite"></ul>
            </div>
            <div class="chat-window">
                <div class="chat-header">
                    <div class="friend-pic" id="chat-friend-pic" onclick="showFriendProfile()"></div>
                    <h2>Chat with <span id="chat-with"></span></h2>
                </div>
                <div id="messages" role="log" aria-live="polite"></div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
                    <button class="btn btn-icon" onclick="document.getElementById('media-input').click()">ðŸ“Ž</button>
                    <input type="file" id="media-input" onchange="sendMedia(event)">
                    <button class="btn" onclick="sendMessage()">Send</button>
                </div>
                <div class="button-group" style="margin-top: clamp(10px, 2vw, 20px);">
                    <button class="btn" onclick="showHome()">Back to Home</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container hidden" id="profilePage">
        <h1 class="elichat-3d">Elichat Profile</h1>
        <div class="user-pic" id="profile-pic"></div>
        <div class="form-group" id="photo-upload-section">
            <input type="file" id="profile-photo" accept="image/*" onchange="uploadProfilePhoto()">
            <button class="btn" onclick="document.getElementById('profile-photo').click()">Upload Photo</button>
            <button class="btn" onclick="useCamera()">Use Camera</button>
            <video id="camera-preview" class="hidden" autoplay></video>
            <button class="btn hidden" id="capture-btn" onclick="capturePhoto()">Capture</button>
        </div>
        <div class="profile-details">
            <p><strong>User ID:</strong> <span id="profile-user-id"></span></p>
            <p><strong>First Name:</strong> <span id="profile-first-name"></span></p>
            <p><strong>Surname:</strong> <span id="profile-surname"></span></p>
            <p><strong>Phone:</strong> <span id="profile-phone"></span></p>
        </div>
        <div class="button-group">
            <button class="btn" onclick="goLive()">Go Live</button>
            <button class="btn" onclick "showHome()">Back to Home</button>
        </div>
    </div>

    <div class="container hidden" id="myStatusPage">
        <h1 class="elichat-3d">My Status</h1>
        <div id="my-status-list"></div>
        <div class="button-group" style="margin-top: clamp(10px, 2vw, 20px);">
            <button class="btn btn-icon" onclick="openStatusModal()">+</button>
            <button class="btn" onclick="showHome()">Back to Home</button>
        </div>
    </div>

    <div id="modal-overlay"></div>
    <div id="status-modal">
        <h2>Edit Status</h2>
        <textarea id="status-text" placeholder="Enter text status (optional)"></textarea>
        <div id="status-previews"></div>
        <div class="button-group">
            <button class="btn" onclick="cropStatus()">Crop Selected</button>
            <button class="btn" onclick="uploadEditedStatus()">Upload All</button>
            <button class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
        </div>
    </div>

    <div id="success-dropdown" class="success-dropdown">Account Created!</div>

    <script>
        let users = JSON.parse(localStorage.getItem("users")) || {};
        let currentUser = null;
        let selectedFriend = null;
        let chatInterval = null;
        let stream = null;
        let isOwnProfile = false;
        let isWifiConnected = false;
        let connectedUsers = JSON.parse(localStorage.getItem("connectedUsers")) || [];
        let statusFiles = [];
        let statusType = null;
        let cropper = null;
        let selectedFileIndex = -1;

        function generateUserId() {
            return 'ELI' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        function showPage(pageId, direction = 'next') {
            const currentPage = document.querySelector('.container.active');
            const nextPage = document.getElementById(pageId);
            if (currentPage) {
                currentPage.classList.remove('active');
                currentPage.classList.add('hidden');
            }
            nextPage.classList.remove('hidden');
            nextPage.classList.add('active');
            if (pageId === 'homePage') {
                updateFriendsList();
                updateStatusList();
                updateConnectedUsers();
                document.getElementById("wifi-options").style.display = "none";
            } else if (pageId === 'chatPage') {
                document.getElementById("chat-with").textContent = selectedFriend.firstName;
                document.getElementById("chat-friend-pic").style.backgroundImage = `url(${selectedFriend.profilePic})`;
                loadMessages();
                if (chatInterval) clearInterval(chatInterval);
                chatInterval = setInterval(loadMessages, 5000);
            } else if (pageId === 'myStatusPage') {
                updateMyStatusList();
            } else if (pageId === 'profilePage') {
                const user = users[currentUser];
                document.getElementById("profile-pic").style.backgroundImage = `url(${user.profilePic})`;
                document.getElementById("profile-user-id").textContent = user.userId;
                document.getElementById("profile-first-name").textContent = user.firstName;
                document.getElementById("profile-surname").textContent = user.surname;
                document.getElementById("profile-phone").textContent = user.phone;
                isOwnProfile = true;
                document.getElementById("photo-upload-section").classList.remove("hidden");
            }
            stopCamera();
        }

        function showLogin() { showPage('loginPage', 'prev'); }
        function showRegister() { showPage('registerPage', 'next'); }
        function showHome() { showPage('homePage', 'next'); }
        function showChat() { showPage('chatPage', 'next'); }
        function showProfile() { showPage('profilePage', 'next'); }
        function showFriendProfile() { 
            showPage('profilePage', 'next');
            document.getElementById("profile-pic").style.backgroundImage = `url(${selectedFriend.profilePic})`;
            document.getElementById("profile-user-id").textContent = selectedFriend.userId;
            document.getElementById("profile-first-name").textContent = selectedFriend.firstName;
            document.getElementById("profile-surname").textContent = selectedFriend.surname;
            document.getElementById("profile-phone").textContent = selectedFriend.phone;
            isOwnProfile = false;
            document.getElementById("photo-upload-section").classList.add("hidden");
        }
        function showMyStatus() { showPage('myStatusPage', 'next'); }

        function register() {
            const firstName = document.getElementById("first-name").value.trim();
            const surname = document.getElementById("surname").value.trim();
            const password = document.getElementById("register-password").value.trim();
            const countryCode = document.getElementById("country-code").value;
            const phoneNumber = document.getElementById("phone-number").value.trim();
            const phone = countryCode + phoneNumber;
            const profilePic = "https://via.placeholder.com/40";
            const userId = generateUserId();

            if (firstName && surname && password && phone) {
                if (Object.values(users).some(u => u.phone === phone)) {
                    alert("Phone number already registered!");
                    return;
                }
                users[phone] = {
                    userId,
                    firstName,
                    surname,
                    password,
                    phone,
                    profilePic,
                    friends: [],
                    messages: {},
                    statuses: []
                };
                localStorage.setItem("users", JSON.stringify(users));
                showSuccessMessage();
                setTimeout(() => {
                    showLogin();
                    document.getElementById("registerPage").querySelector("form").reset();
                }, 2000);
            } else {
                alert("Please fill in all required fields!");
            }
        }

        function login() {
            const countryCode = document.getElementById("login-country-code").value;
            const phoneNumber = document.getElementById("login-phone-number").value.trim();
            const phone = countryCode + phoneNumber;
            const password = document.getElementById("login-password").value.trim();

            if (users[phone] && users[phone].password === password) {
                currentUser = phone;
                showHome();
            } else {
                alert("Invalid phone number or password!");
            }
        }

        function logout() {
            if (isWifiConnected) {
                connectedUsers = connectedUsers.filter(phone => phone !== currentUser);
                localStorage.setItem("connectedUsers", JSON.stringify(connectedUsers));
                isWifiConnected = false;
            }
            currentUser = null;
            showLogin();
        }

        function addFriend() {
            const phone = document.getElementById("add-friend").value.trim();
            if (!phone || phone === currentUser) {
                alert("Enter a valid phone number!");
                return;
            }
            if (!users[phone]) {
                alert("User not found!");
                return;
            }
            const friendFirstName = users[phone].firstName;
            if (users[currentUser].friends.includes(friendFirstName)) {
                alert("Already your friend!");
                return;
            }
            users[currentUser].friends.push(friendFirstName);
            users[phone].friends.push(users[currentUser].firstName);
            localStorage.setItem("users", JSON.stringify(users));
            updateFriendsList();
            document.getElementById("add-friend").value = "";
            alert(`${friendFirstName} added as a friend!`);
        }

        function updateFriendsList() {
            const friendsList = document.getElementById("friends-list");
            friendsList.innerHTML = "";
            const userFriends = users[currentUser]?.friends || [];
            userFriends.forEach(friendFirstName => {
                const friend = Object.values(users).find(u => u.firstName === friendFirstName);
                if (friend) {
                    const chatKey = [users[currentUser].firstName, friendFirstName].sort().join('-');
                    const messages = users[currentUser].messages[chatKey] || [];
                    const recentMessage = messages.length > 0 ? 
                        (messages[messages.length - 1].type === "text" ? messages[messages.length - 1].text : `[${messages[messages.length - 1].filename || "File"}]`) : 
                        "No recent activity";
                    const lastMessageTime = messages.length > 0 ? new Date(messages[messages.length - 1].timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "";
                    const hasUnread = messages.some(msg => !msg.read && msg.to === users[currentUser].firstName);

                    const li = document.createElement("li");
                    li.className = hasUnread ? "unread" : "";
                    li.innerHTML = `
                        <img src="${friend.profilePic}" class="friend-pic" alt="${friendFirstName}'s pic">
                        <div class="friend-info">
                            ${friendFirstName} ${isWifiConnected && connectedUsers.includes(friend.phone) ? '(Nearby)' : ''}
                            <div class="recent-message">${recentMessage}</div>
                        </div>
                        <span class="timestamp">${lastMessageTime}</span>
                    `;
                    li.setAttribute("tabindex", "0");
                    li.onclick = () => openChat(friend);
                    li.onkeydown = (e) => { if (e.key === "Enter" || e.key === "Space") openChat(friend); };
                    friendsList.appendChild(li);
                }
            });
            friendsList.scrollTop = 0; // Always show newest at top
            updateStatusList();
        }

        function updateStatusList() {
            const statusList = document.getElementById("status-list");
            statusList.innerHTML = "";
            const now = Date.now();
            const friends = users[currentUser]?.friends || [];

            if (friends.length === 0) {
                const div = document.createElement("div");
                div.className = "status-item";
                div.textContent = "No friends' statuses available yet. Add friends to see their updates!";
                statusList.appendChild(div);
            } else {
                let hasStatuses = false;
                friends.forEach(friendFirstName => {
                    const friend = Object.values(users).find(u => u.firstName === friendFirstName);
                    if (friend && friend.statuses && friend.statuses.length > 0) {
                        friend.statuses = friend.statuses.filter(status => now - status.timestamp < 24 * 60 * 60 * 1000);
                        if (friend.statuses.length > 0) {
                            const groupDiv = document.createElement("div");
                            groupDiv.className = "friend-status-group";

                            const nameDiv = document.createElement("div");
                            nameDiv.className = "friend-name";
                            nameDiv.innerHTML = `
                                <img src="${friend.profilePic}" class="friend-pic" alt="${friendFirstName}'s pic">
                                ${friendFirstName}
                            `;
                            groupDiv.appendChild(nameDiv);

                            friend.statuses.sort((a, b) => b.timestamp - a.timestamp); // Newest first within friend
                            friend.statuses.forEach(status => {
                                const li = document.createElement("div");
                                li.className = "status-item";
                                li.innerHTML = `
                                    <img src="${friend.profilePic}" class="status-pic" alt="${friendFirstName}'s pic">
                                    <div class="status-item-content">
                                        ${status.type === "text" ? status.content : 
                                          status.type === "image" ? `<img src="${status.content}" alt="${status.filename || 'Status image'}">` :
                                          status.type === "video" ? `<video controls src="${status.content}"></video>` :
                                          `<a href="${status.content}" download="${status.filename || 'file'}"><img src="https://cdn-icons-png.flaticon.com/512/136/136523.png" class="file-icon" alt="File">${status.filename || 'Download File'}</a>`}
                                    </div>
                                `;
                                groupDiv.appendChild(li);
                            });

                            statusList.appendChild(groupDiv);
                            hasStatuses = true;
                            localStorage.setItem("users", JSON.stringify(users));
                        }
                    }
                });

                if (!hasStatuses) {
                    const div = document.createElement("div");
                    div.className = "status-item";
                    div.textContent = "Your friends haven't posted any statuses yet or they have expired!";
                    statusList.appendChild(div);
                }
            }
        }

        function updateMyStatusList() {
            const myStatusList = document.getElementById("my-status-list");
            myStatusList.innerHTML = "";
            const now = Date.now();
            const user = users[currentUser];

            if (user && user.statuses) {
                user.statuses = user.statuses.filter(status => now - status.timestamp < 24 * 60 * 60 * 1000);
                user.statuses.sort((a, b) => b.timestamp - a.timestamp); // Newest first
                user.statuses.forEach(status => {
                    const item = document.createElement("div");
                    item.className = "my-status-item";
                    if (status.type === "text") {
                        item.textContent = `${user.firstName}: ${status.content}`;
                    } else if (status.type === "image") {
                        item.innerHTML = `${user.firstName}: <img src="${status.content}" alt="${status.filename || 'Status image'}">`;
                    } else if (status.type === "video") {
                        item.innerHTML = `${user.firstName}: <video controls src="${status.content}"></video>`;
                    } else {
                        item.innerHTML = `${user.firstName}: <a href="${status.content}" download="${status.filename || 'file'}"><img src="https://cdn-icons-png.flaticon.com/512/136/136523.png" class="file-icon" alt="File">${status.filename || 'Download File'}</a>`;
                    }
                    myStatusList.appendChild(item);
                });
                localStorage.setItem("users", JSON.stringify(users));
            }
        }

        function openStatusModal() {
            document.getElementById("status-modal").style.display = "block";
            document.getElementById("modal-overlay").style.display = "block";
            document.getElementById("status-text").value = "";
            document.getElementById("status-previews").innerHTML = "";
            statusFiles = [];
            selectedFileIndex = -1;
            document.getElementById("status-input").click();
        }

        function handleStatusInput(event) {
            statusFiles = Array.from(event.target.files);
            if (statusFiles.length === 0) return;

            const previews = document.getElementById("status-previews");
            previews.innerHTML = "";
            statusFiles.forEach((file, index) => {
                const container = document.createElement("div");
                container.style.marginBottom = "10px";
                container.style.cursor = "pointer";
                container.onclick = () => selectFileForCrop(index);

                if (file.type.startsWith("image")) {
                    const img = document.createElement("img");
                    img.src = URL.createObjectURL(file);
                    img.style.width = "100px";
                    img.style.height = "auto";
                    container.appendChild(img);
                } else if (file.type.startsWith("video")) {
                    const video = document.createElement("video");
                    video.src = URL.createObjectURL(file);
                    video.style.width = "100px";
                    video.style.height = "auto";
                    video.controls = true;
                    container.appendChild(video);
                }
                previews.appendChild(container);
            });

            selectFileForCrop(0);
        }

        function selectFileForCrop(index) {
            if (index < 0 || index >= statusFiles.length) return;

            selectedFileIndex = index;
            const file = statusFiles[index];
            const canvas = document.getElementById("status-canvas");
            const video = document.getElementById("status-video");
            const ctx = canvas.getContext("2d");

            if (file.type.startsWith("image")) {
                statusType = "image";
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    canvas.style.display = "block";
                    video.style.display = "none";
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(canvas, {
                        aspectRatio: NaN,
                        viewMode: 1,
                        autoCropArea: 1.0
                    });
                };
                img.src = URL.createObjectURL(file);
            } else if (file.type.startsWith("video")) {
                statusType = "video";
                video.src = URL.createObjectURL(file);
                video.style.display = "block";
                canvas.style.display = "none";
                if (cropper) cropper.destroy();
            }
        }

        function cropStatus() {
            if (statusType === "image" && cropper && selectedFileIndex >= 0) {
                const croppedCanvas = cropper.getCroppedCanvas();
                const canvas = document.getElementById("status-canvas");
                canvas.width = croppedCanvas.width;
                canvas.height = croppedCanvas.height;
                canvas.getContext("2d").drawImage(croppedCanvas, 0, 0);
                statusFiles[selectedFileIndex] = new File([canvas.toBlob(blob => blob)], statusFiles[selectedFileIndex].name, { type: "image/png" });
                cropper.destroy();
                cropper = null;
                selectFileForCrop(selectedFileIndex);
            } else if (statusType === "video") {
                alert("Video trimming not implemented yet. Uploads full video.");
            }
        }

        function uploadEditedStatus() {
            const text = document.getElementById("status-text").value.trim();
            if (text) {
                const status = {
                    content: text,
                    type: "text",
                    timestamp: Date.now()
                };
                if (!users[currentUser].statuses) users[currentUser].statuses = [];
                users[currentUser].statuses.push(status);
            }

            if (statusFiles.length > 0) {
                let processed = 0;
                statusFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const status = {
                            content: e.target.result,
                            filename: file.name,
                            type: file.type.startsWith('image') ? "image" : "video",
                            timestamp: Date.now()
                        };
                        if (!users[currentUser].statuses) users[currentUser].statuses = [];
                        users[currentUser].statuses.push(status);
                        processed++;
                        if (processed === statusFiles.length) {
                            localStorage.setItem("users", JSON.stringify(users));
                            updateStatusList();
                            updateMyStatusList();
                            closeStatusModal();
                        }
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                localStorage.setItem("users", JSON.stringify(users));
                updateStatusList();
                updateMyStatusList();
                closeStatusModal();
            }
        }

        function closeStatusModal() {
            document.getElementById("status-modal").style.display = "none";
            document.getElementById("modal-overlay").style.display = "none";
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            statusFiles = [];
            statusType = null;
            selectedFileIndex = -1;
            document.getElementById("status-text").value = "";
            document.getElementById("status-previews").innerHTML = "";
            document.getElementById("status-canvas").style.display = "none";
            document.getElementById("status-video").style.display = "none";
        }

        function openChat(friend) {
            selectedFriend = friend;
            // Mark messages as read for this friend
            const chatKey = [users[currentUser].firstName, friend.firstName].sort().join('-');
            if (users[currentUser].messages[chatKey]) {
                users[currentUser].messages[chatKey].forEach(msg => {
                    if (msg.to === users[currentUser].firstName && !msg.read) {
                        msg.read = true;
                    }
                });
                localStorage.setItem("users", JSON.stringify(users));
            }
            showChat();
        }

        function loadMessages() {
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML = "";
            const chatKey = [users[currentUser].firstName, selectedFriend.firstName].sort().join('-');
            const messages = users[currentUser].messages[chatKey] || [];
            messages.sort((a, b) => a.timestamp - b.timestamp); // Sort by timestamp ascending
            messages.forEach(msg => {
                const div = document.createElement("div");
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                div.className = msg.from === users[currentUser].firstName ? "message sent" : "message received";
                if (msg.type === "text") {
                    div.innerHTML = `${msg.text}<span class="timestamp" style="font-size: clamp(8px, 1.5vw, 10px); display: block; margin-top: 5px;">${time}</span>`;
                } else if (msg.type === "image") {
                    div.innerHTML = `<img src="${msg.content}" alt="${msg.filename || 'Sent image'}"><span class="timestamp" style="font-size: clamp(8px, 1.5vw, 10px); display: block; margin-top: 5px;">${time}</span>`;
                } else if (msg.type === "audio") {
                    div.innerHTML = `<audio controls src="${msg.content}"></audio><span class="timestamp" style="font-size: clamp(8px, 1.5vw, 10px); display: block; margin-top: 5px;">${time}</span>`;
                } else {
                    div.innerHTML = `<a href="${msg.content}" download="${msg.filename || 'file'}"><img src="https://cdn-icons-png.flaticon.com/512/136/136523.png" class="file-icon" alt="File">${msg.filename || 'Download File'}</a><span class="timestamp" style="font-size: clamp(8px, 1.5vw, 10px); display: block; margin-top: 5px;">${time}</span>`;
                }
                messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById("message-input");
            const text = input.value.trim();
            if (text && selectedFriend) {
                const chatKey = [users[currentUser].firstName, selectedFriend.firstName].sort().join('-');
                const message = { from: users[currentUser].firstName, to: selectedFriend.firstName, text, type: "text", timestamp: Date.now(), read: false };

                if (!users[currentUser].messages[chatKey]) users[currentUser].messages[chatKey] = [];
                users[currentUser].messages[chatKey].push(message);

                const friendPhone = selectedFriend.phone;
                if (!users[friendPhone].messages[chatKey]) users[friendPhone].messages[chatKey] = [];
                users[friendPhone].messages[chatKey].push({ ...message, to: users[friendPhone].firstName, from: users[currentUser].firstName, read: false });

                localStorage.setItem("users", JSON.stringify(users));
                loadMessages();
                updateFriendsList();
                input.value = "";
            }
        }

        function sendMedia(event) {
            const file = event.target.files[0];
            if (file && selectedFriend) {
                const chatKey = [users[currentUser].firstName, selectedFriend.firstName].sort().join('-');
                const reader = new FileReader();
                reader.onload = function(e) {
                    const message = {
                        from: users[currentUser].firstName,
                        to: selectedFriend.firstName,
                        content: e.target.result,
                        filename: file.name,
                        type: file.type.startsWith('image') ? "image" : 
                              file.type.startsWith('audio') ? "audio" : "file",
                        timestamp: Date.now(),
                        read: false
                    };

                    if (!users[currentUser].messages[chatKey]) users[currentUser].messages[chatKey] = [];
                    users[currentUser].messages[chatKey].push(message);

                    const friendPhone = selectedFriend.phone;
                    if (!users[friendPhone].messages[chatKey]) users[friendPhone].messages[chatKey] = [];
                    users[friendPhone].messages[chatKey].push({ ...message, to: users[friendPhone].firstName, from: users[currentUser].firstName, read: false });

                    localStorage.setItem("users", JSON.stringify(users));
                    loadMessages();
                    updateFriendsList();
                };
                reader.readAsDataURL(file);
                event.target.value = "";
            }
        }

        function toggleWifiOptions() {
            const options = document.getElementById("wifi-options");
            options.style.display = options.style.display === "block" ? "none" : "block";
            options.style.left = `${document.getElementById("wifi-btn").offsetLeft}px`;
            options.style.top = `${document.getElementById("wifi-btn").offsetTop + document.getElementById("wifi-btn").offsetHeight}px`;
        }

        function connectWifi(type) {
            if (!isWifiConnected) {
                isWifiConnected = true;
                connectedUsers.push(currentUser);
                users[currentUser].friends.forEach(friendFirstName => {
                    const friend = Object.values(users).find(u => u.firstName === friendFirstName);
                    if (friend && Math.random() > 0.5) {
                        connectedUsers.push(friend.phone);
                    }
                });
                localStorage.setItem("connectedUsers", JSON.stringify([...new Set(connectedUsers)]));
                alert(`Connected to ${type}! Nearby users can now message and transfer files for free.`);
            } else {
                alert(`Already connected via ${type}.`);
            }
            updateConnectedUsers();
            document.getElementById("wifi-options").style.display = "none";
        }

        function goLive() {
            alert("Going live is not fully implemented yet. This would start a live stream visible to your friends!");
        }

        function updateConnectedUsers() {
            const connectedUsersDiv = document.getElementById("connected-users");
            if (isWifiConnected) {
                connectedUsersDiv.innerHTML = "<strong>Nearby Users:</strong> " + 
                    (connectedUsers.length > 0 ? connectedUsers.map(phone => users[phone].firstName).join(", ") : "None");
            } else {
                connectedUsersDiv.innerHTML = "<strong>Nearby Users:</strong> Not connected";
            }
        }

        function uploadProfilePhoto() {
            const file = document.getElementById("profile-photo").files[0];
            if (file && isOwnProfile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    users[currentUser].profilePic = e.target.result;
                    localStorage.setItem("users", JSON.stringify(users));
                    document.getElementById("profile-pic").style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById("user-pic").style.backgroundImage = `url(${e.target.result})`;
                    if (selectedFriend && selectedFriend.phone === currentUser) {
                        selectedFriend.profilePic = e.target.result;
                        document.getElementById("chat-friend-pic").style.backgroundImage = `url(${e.target.result})`;
                    }
                    updateFriendsList();
                };
                reader.readAsDataURL(file);
            }
        }

        function useCamera() {
            if (!isOwnProfile) return;
            const video = document.getElementById("camera-preview");
            const captureBtn = document.getElementById("capture-btn");
            video.classList.remove("hidden");
            captureBtn.classList.remove("hidden");

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(mediaStream => {
                    stream = mediaStream;
                    video.srcObject = stream;
                })
                .catch(err => {
                    alert("Camera access denied or unavailable: " + err.message);
                    video.classList.add("hidden");
                    captureBtn.classList.add("hidden");
                });
        }

        function capturePhoto() {
            if (!isOwnProfile) return;
            const video = document.getElementById("camera-preview");
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            const photoData = canvas.toDataURL("image/png");
            users[currentUser].profilePic = photoData;
            localStorage.setItem("users", JSON.stringify(users));
            document.getElementById("profile-pic").style.backgroundImage = `url(${photoData})`;
            document.getElementById("user-pic").style.backgroundImage = `url(${photoData})`;
            if (selectedFriend && selectedFriend.phone === currentUser) {
                selectedFriend.profilePic = photoData;
                document.getElementById("chat-friend-pic").style.backgroundImage = `url(${photoData})`;
            }
            updateFriendsList();
            stopCamera();
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById("camera-preview").classList.add("hidden");
            document.getElementById("capture-btn").classList.add("hidden");
        }

        function showSuccessMessage() {
            const successDropdown = document.getElementById("success-dropdown");
            successDropdown.style.display = "block";
            setTimeout(() => {
                successDropdown.style.display = "none";
            }, 2000);
        }

        // Initialize
        showLogin();
        setInterval(() => { 
            if (document.getElementById("homePage").classList.contains("active")) {
                updateStatusList();
            }
            updateMyStatusList(); 
            if (document.getElementById("chatPage").classList.contains("active")) {
                updateFriendsList();
                loadMessages(); // Ensure chat updates when active
            }
        }, 60000);

        // Include Cropper.js dynamically
        const script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js";
        document.head.appendChild(script);
    </script>
</body>
</html>
